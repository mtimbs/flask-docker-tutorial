trigger:
  branches:
    include:
    - master
    - dev
    exclude:
    - feature/*

# specific branch build
pr:
  branches:
    include:
    - master
    - dev
    - feature/*

variables:
    - name: vmImageName
      value: 'ubuntu-latest'
    - name: dockerfilePath
      value: './Dockerfile'
    - name: imageName
      value: flask

stages:
  # Protect against deploys running pipenv --install on a repo with no lockfile
  - stage: Precheck
    jobs:
    - job: Lockfile
      steps:
        - bash: |
            if [! -e Pipfile.lock ]; then
              echo "NO LOCK FILE."; false
            fi
          displayName: 'Check for lockfile'

  # Don't deploy if dependencies have known security vulnerabilities
    - job: Security
      pool:
        vmImage:  $(vmImageName)
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.7'
              architecture: 'x64'
          - script: |
              sudo -H pip install -U pipenv
              pipenv check
            displayName: 'Check for known security vulnerabilities in dependencies'

  - stage: Test
    # Fail if tests don't pass
    jobs:
      - job: tests
        pool:
          vmImage:  $(vmImageName)
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.7'
              architecture: 'x64'
          - script: |
              sudo -H pip install -U pipenv
              pipenv install --dev
              pipenv run pytest tests
            displayName: 'Run tests'


  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build
        displayName: Build and Push
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: DockerCompose@0
            inputs:
              azureSubscriptionEndpoint: AzureRM
              azureContainerRegistry: mtimbs
              dockerComposeFile: docker-compose.yml
              projectName: $(imageName)
              action: 'Build services'
              includeSourceTags: true
              includeLatestTag: true
          - task: DockerCompose@0
            inputs:
              azureSubscriptionEndpoint: AzureRM
              azureContainerRegistry: mtimbs
              dockerComposeFile: docker-compose.yml
              projectName: $(imageName)
              action: 'Push services'
              includeSourceTags: true
              includeLatestTag: true

